<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkariNet Automata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #d0bcff;
            --md-sys-color-on-primary: #381e72;
            --md-sys-color-primary-container: #4f378b;
            --md-sys-color-on-primary-container: #eaddff;
            --md-sys-color-surface: #1c1b1f;
            --md-sys-color-on-surface: #e6e1e5;
            --md-sys-color-surface-variant: #49454f;
            --md-sys-color-on-surface-variant: #cac4d0;
            --md-sys-color-outline: #938f99;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .m3-sidebar {
            width: 280px;
            background-color: #2b2930;
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        @media (max-width: 768px) {
            .m3-sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
            }
            .m3-sidebar.open { transform: translateX(0); }
        }

        .nav-item {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-radius: 28px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.2s;
            color: var(--md-sys-color-on-surface-variant);
        }

        .nav-item.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .m3-card {
            background-color: #25232a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--md-sys-color-surface-variant);
        }

        .m3-input {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 12px;
            color: white;
            width: 100%;
            margin-top: 8px;
        }

        .m3-input:focus { border-color: var(--md-sys-color-primary); outline: none; }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        #code-editor {
            flex-grow: 1;
            font-family: 'monospace';
            background: #131217;
            border-radius: 8px;
            resize: none;
            padding: 16px;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar" class="m3-sidebar">
        <div class="px-4 py-6 text-xl font-medium text-primary" style="color: var(--md-sys-color-primary)">AkariNet Automata</div>
        
        <div class="nav-item active" onclick="switchTab('registry')">
            <span class="mr-4">※</span> Registry
        </div>
        <div class="nav-item" onclick="switchTab('editor')">
            <span class="mr-4">※</span> Editor
        </div>
        <div class="nav-item" onclick="switchTab('sources')">
            <span class="mr-4">※</span> Sources
        </div>
        
        <div class="mt-auto p-4">
            <input type="file" id="atpk-upload" class="hidden" accept=".atpk,.txt" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('atpk-upload').click()" class="w-full py-3 rounded-full border border-dashed border-outline text-sm">
                Upload .atpk
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Top Bar (Mobile) -->
        <header class="h-16 flex items-center px-4 md:hidden border-b border-surface-variant">
            <button onclick="toggleSidebar()" class="text-2xl">☰</button>
            <div class="ml-4 font-medium">Automaton Manager</div>
        </header>

        <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <!-- Registry Tab -->
            <section id="tab-registry">
                <div class="flex justify-between items-end mb-6">
                    <h1 class="text-3xl font-light">Registry</h1>
                    <div id="validation-msg" class="text-xs text-red-400"></div>
                </div>
                <div id="registry-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Cards -->
                </div>
            </section>

            <!-- Editor Tab -->
            <section id="tab-editor" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-light">Editor</h1>
                    <div class="flex gap-2">
                        <button onclick="saveDraft()" class="px-4 py-2 rounded-full bg-surface-variant text-sm">Save to this AkariNet</button>
                        <button onclick="exportAtpk()" class="px-4 py-2 rounded-full bg-primary text-on-primary bg-[#d0bcff] text-[#381e72] text-sm font-bold">Download</button>
                    </div>
                </div>
                <div class="editor-container gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="edit-name" placeholder="Automaton Name" class="m3-input">
                        <input id="edit-version" placeholder="Version (1.0.0)" class="m3-input">
                        <input id="edit-author" placeholder="Author" class="m3-input">
                    </div>
                    <textarea id="edit-desc" placeholder="Description" class="m3-input h-20"></textarea>
                    <textarea id="code-editor" spellcheck="false" placeholder="// JavaScript Code here..."></textarea>
                </div>
            </section>

            <!-- Sources Tab -->
            <section id="tab-sources" class="hidden">
                <h1 class="text-3xl font-light mb-6">Sources</h1>
                <div class="m3-card mb-6">
                    <div class="flex gap-2">
                        <input id="source-url" placeholder="Add .atpk URL" class="m3-input mt-0">
                        <button onclick="addSource()" class="bg-primary-container px-6 rounded-lg">Add</button>
                    </div>
                </div>
                <div id="source-list" class="space-y-2"></div>
            </section>

        </div>

        <!-- FAB (Add New) -->
        <div id="main-fab" class="fab" onclick="createNew()">
            <span>+</span>
        </div>
    </main>

    <script>
        let registry = JSON.parse(localStorage.getItem('akari_local_registry') || '[]');
        let currentEditId = null;
        let sources = JSON.parse(localStorage.getItem('akari:automata_urls') || '[]');

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function switchTab(tab) {
            ['registry', 'editor', 'sources'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const navs = document.querySelectorAll('.nav-item');
            if(tab === 'registry') navs[0].classList.add('active');
            if(tab === 'editor') navs[1].classList.add('active');
            if(tab === 'sources') navs[2].classList.add('active');
            
            if(window.innerWidth < 768) toggleSidebar();
            
            document.getElementById('main-fab').style.display = (tab === 'registry') ? 'flex' : 'none';
        }

        function createNew() {
            currentEditId = null;
            clearEditor();
            switchTab('editor');
        }

        function clearEditor() {
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-version').value = '1.0.0';
            document.getElementById('edit-author').value = '';
            document.getElementById('edit-desc').value = '';
            document.getElementById('code-editor').value = '';
        }

        function validateAtpk(data) {
            if(!data.name || data.name.length < 2) return "Invalid Name";
            if(!data.code || data.code.length < 5) return "Code is too short";
            try {
                // Simple syntax check
                new Function(data.code);
            } catch(e) {
                return "Syntax Error: " + e.message;
            }
            return null;
        }

        function saveDraft() {
            const data = {
                id: currentEditId || Date.now(),
                name: document.getElementById('edit-name').value,
                version: document.getElementById('edit-version').value,
                author: document.getElementById('edit-author').value,
                description: document.getElementById('edit-desc').value,
                code: document.getElementById('code-editor').value,
                lastUpdated: new Date().toISOString()
            };

            const error = validateAtpk(data);
            if(error) {
                showToast(error, true);
                return;
            }

            const idx = registry.findIndex(r => r.id === data.id);
            if(idx > -1) registry[idx] = data;
            else registry.push(data);

            localStorage.setItem('akari_local_registry', JSON.stringify(registry));
            showToast("Saved to local registry");
            renderRegistry();
            switchTab('registry');
        }

        function editAutomaton(id) {
            const item = registry.find(r => r.id === id);
            if(!item) return;
            currentEditId = id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-version').value = item.version;
            document.getElementById('edit-author').value = item.author || '';
            document.getElementById('edit-desc').value = item.description;
            document.getElementById('code-editor').value = item.code;
            switchTab('editor');
        }

        function deleteAutomaton(id) {
            registry = registry.filter(r => r.id !== id);
            localStorage.setItem('akari_local_registry', JSON.stringify(registry));
            renderRegistry();
        }

        function exportAtpk() {
            const name = document.getElementById('edit-name').value || 'untitled';
            const code = document.getElementById('code-editor').value;
            const content = `atpk-name: Exported Package\natpk-description: Single export\n\n!AUTOMATON\nname: ${name}\nversion: ${document.getElementById('edit-version').value}\ndescription: ${document.getElementById('edit-desc').value}\ncode>\n${code}\n<code`;
            
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.atpk`;
            a.click();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                // Basic ATPK parse
                if(text.includes('!AUTOMATON')) {
                    const nameMatch = text.match(/name:\s*(.*)/);
                    const codeMatch = text.match(/code>([\s\S]*)<code/);
                    if(nameMatch && codeMatch) {
                        registry.push({
                            id: Date.now(),
                            name: nameMatch[1].trim(),
                            version: '1.0.0',
                            description: 'Imported file',
                            code: codeMatch[1].trim()
                        });
                        localStorage.setItem('akari_local_registry', JSON.stringify(registry));
                        renderRegistry();
                        showToast("Imported successfully");
                    }
                }
            };
            reader.readAsText(file);
        }

        function renderRegistry() {
            const list = document.getElementById('registry-list');
            list.innerHTML = registry.map(item => `
                <div class="m3-card group relative">
                    <div class="flex justify-between items-start">
                        <div class="font-medium text-lg">${item.name}</div>
                        <div class="text-xs text-outline">v${item.version}</div>
                    </div>
                    <div class="text-sm text-on-surface-variant mt-2 line-clamp-2">${item.description || 'No description'}</div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="editAutomaton(${item.id})" class="text-xs py-1 px-3 rounded-full bg-primary-container">Edit</button>
                        <button onclick="deleteAutomaton(${item.id})" class="text-xs py-1 px-3 rounded-full border border-outline">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showToast(msg, isError = false) {
            const div = document.createElement('div');
            div.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-sm z-[100] transition-all duration-300 ${isError ? 'bg-red-900 text-white' : 'bg-[#eaddff] text-[#21005d]'}`;
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300); }, 3000);
        }

        // Initialize
        renderRegistry();
        switchTab('registry');
    </script>
</body>
</html>
