<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkariNet Automata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #d0bcff;
            --md-sys-color-on-primary: #381e72;
            --md-sys-color-primary-container: #4f378b;
            --md-sys-color-on-primary-container: #eaddff;
            --md-sys-color-surface: #1c1b1f;
            --md-sys-color-on-surface: #e6e1e5;
            --md-sys-color-surface-variant: #49454f;
            --md-sys-color-on-surface-variant: #cac4d0;
            --md-sys-color-outline: #938f99;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2b2930; }
        ::-webkit-scrollbar-thumb { background: #49454f; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #938f99; }

        .m3-sidebar {
            width: 280px;
            background-color: #2b2930;
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        @media (max-width: 768px) {
            .m3-sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
            }
            .m3-sidebar.open { transform: translateX(0); }
        }

        .nav-item {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-radius: 28px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.2s;
            color: var(--md-sys-color-on-surface-variant);
        }

        .nav-item.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .m3-card {
            background-color: #25232a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--md-sys-color-surface-variant);
            transition: transform 0.2s;
        }
        
        .m3-card:hover { border-color: var(--md-sys-color-primary); }

        .m3-input {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 12px;
            color: white;
            width: 100%;
            margin-top: 8px;
            font-family: inherit;
        }

        .m3-input:focus { border-color: var(--md-sys-color-primary); outline: none; }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 24px;
            z-index: 40;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        #code-editor {
            flex-grow: 1;
            font-family: 'monospace';
            background: #131217;
            border-radius: 8px;
            resize: none;
            padding: 16px;
            color: #e6e1e5;
            line-height: 1.5;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.open { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: #2b2930;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            border: 1px solid var(--md-sys-color-outline);
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .modal-overlay.open .modal-content { transform: scale(1); }

        .badge-remote {
            background-color: #004a77;
            color: #c2e7ff;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>
<body>

    <div id="details-modal" class="modal-overlay" onclick="if(event.target === this) closeDetails()">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 id="modal-name" class="text-2xl font-bold text-[#d0bcff]">Automaton Name</h2>
                    <div class="text-sm text-gray-400 mt-1">v<span id="modal-version">1.0.0</span> â€¢ by <span id="modal-author">Unknown</span></div>
                </div>
                <button onclick="closeDetails()" class="text-2xl leading-none">&times;</button>
            </div>
            
            <div class="bg-[#1c1b1f] p-4 rounded-lg mb-4 border border-[#49454f]">
                <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">Description</h3>
                <p id="modal-desc" class="text-sm leading-relaxed text-gray-300">Description goes here...</p>
            </div>

            <div class="bg-[#1c1b1f] p-4 rounded-lg border border-[#49454f] flex-1 min-h-[200px]">
                <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">Code Snippet</h3>
                <pre id="modal-code" class="text-xs font-mono text-green-400 overflow-x-auto whitespace-pre-wrap h-64 overflow-y-auto"></pre>
            </div>

            <div class="flex justify-end mt-6 gap-2">
                <button onclick="closeDetails()" class="px-6 py-2 rounded-full border border-[#938f99] text-sm">Close</button>
                <button id="modal-edit-btn" class="px-6 py-2 rounded-full bg-[#4f378b] text-[#eaddff] text-sm font-medium">Clone to Edit</button>
            </div>
        </div>
    </div>

    <nav id="sidebar" class="m3-sidebar">
        <div class="px-4 py-6 text-xl font-medium" style="color: var(--md-sys-color-primary)">AkariNet Automata</div>
        
        <div class="nav-item active" onclick="switchTab('registry')">
            <span class="mr-4">â€»</span> Registry
        </div>
        <div class="nav-item" onclick="switchTab('editor')">
            <span class="mr-4">â€»</span> Editor
        </div>
        <div class="nav-item" onclick="switchTab('sources')">
            <span class="mr-4">â€»</span> Sources
        </div>
        
        <div class="mt-auto p-4">
            <input type="file" id="atpk-upload" class="hidden" accept=".atpk,.txt" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('atpk-upload').click()" class="w-full py-3 rounded-full border border-dashed border-[#938f99] text-sm hover:bg-[#49454f] transition">
                Upload .atpk
            </button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-16 flex items-center px-4 md:hidden border-b border-[#49454f] bg-[#1c1b1f]">
            <button onclick="toggleSidebar()" class="text-2xl p-2">â˜°</button>
            <div class="ml-4 font-medium">Automaton Manager</div>
        </header>

        <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <section id="tab-registry">
                <div class="flex justify-between items-end mb-6">
                    <h1 class="text-3xl font-light">Registry</h1>
                    <div id="loader-indicator" class="hidden text-xs text-[#d0bcff]">Fetching remote sources...</div>
                </div>
                <div id="registry-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                <div id="empty-state" class="hidden flex-col items-center justify-center py-20 opacity-50">
                    <div class="text-6xl mb-4">ðŸ“‚</div>
                    <p>No automatons found locally or remotely.</p>
                </div>
            </section>

            <section id="tab-editor" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-light">Editor</h1>
                    <div class="flex gap-2">
                        <button onclick="saveDraft()" class="px-4 py-2 rounded-full bg-[#49454f] text-sm hover:bg-[#5b5763]">Save Local</button>
                        <button onclick="exportAtpk()" class="px-4 py-2 rounded-full bg-[#d0bcff] text-[#381e72] text-sm font-bold hover:bg-[#e8def8]">Download</button>
                    </div>
                </div>
                <div class="editor-container gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="edit-name" placeholder="Automaton Name" class="m3-input">
                        <input id="edit-version" placeholder="Version (1.0.0)" class="m3-input">
                        <input id="edit-author" placeholder="Author" class="m3-input">
                    </div>
                    <textarea id="edit-desc" placeholder="Description" class="m3-input h-20"></textarea>
                    <textarea id="code-editor" spellcheck="false" placeholder="// JavaScript Code here..."></textarea>
                </div>
            </section>

            <section id="tab-sources" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-light">Sources</h1>
                    <button onclick="refreshRemote()" class="text-sm text-[#d0bcff] border border-[#d0bcff] px-3 py-1 rounded-full">Refresh Data</button>
                </div>
                <div class="m3-card mb-6">
                    <label class="text-xs text-[#cac4d0] uppercase">Add New Source URL</label>
                    <div class="flex gap-2 mt-2">
                        <input id="source-url" placeholder="https://example.com/repo.atpk" class="m3-input mt-0">
                        <button onclick="addSource()" class="bg-[#4f378b] text-[#eaddff] px-6 rounded-lg font-medium">Add</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Note: URL must be a direct link to a raw text file (e.g., GitHub Raw).</p>
                </div>
                <div id="source-list" class="space-y-2">
                    </div>
            </section>

        </div>

        <div id="main-fab" class="fab" onclick="createNew()">
            <span>+</span>
        </div>
    </main>

    <script>
        // State
        let localRegistry = JSON.parse(localStorage.getItem('akari_local_registry') || '[]');
        let remoteRegistry = []; // Stores items fetched from URLs
        let sources = JSON.parse(localStorage.getItem('akari_automata_urls') || '[]');
        let currentEditId = null;

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            renderSources();
            refreshRemote(); // Fetch data on load
        });

        // --- Core UI Functions ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function switchTab(tab) {
            ['registry', 'editor', 'sources'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
            });
            
            const navs = document.querySelectorAll('.nav-item');
            navs.forEach(n => n.classList.remove('active'));
            if(tab === 'registry') navs[0].classList.add('active');
            if(tab === 'editor') navs[1].classList.add('active');
            if(tab === 'sources') navs[2].classList.add('active');

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
            document.getElementById('main-fab').style.display = (tab === 'registry') ? 'flex' : 'none';
        }

        function showToast(msg, isError = false) {
            const existing = document.querySelector('.akari-toast');
            if(existing) existing.remove();

            const div = document.createElement('div');
            div.className = `akari-toast fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-sm z-[100] transition-all duration-300 ${isError ? 'bg-red-900 text-white' : 'bg-[#eaddff] text-[#21005d]'}`;
            div.innerText = msg;
            document.body.appendChild(div);
            
            requestAnimationFrame(() => {
                div.style.opacity = '1';
                div.style.transform = 'translate(-50%, 0)';
            });

            setTimeout(() => { 
                div.style.opacity = '0'; 
                setTimeout(() => div.remove(), 300); 
            }, 3000);
        }

        // --- Data Fetching Logic (The Missing Piece) ---
        async function refreshRemote() {
            if(sources.length === 0) {
                renderRegistry();
                return;
            }

            const loader = document.getElementById('loader-indicator');
            loader.classList.remove('hidden');
            remoteRegistry = []; // Clear old fetches

            const fetchPromises = sources.map(async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load');
                    const text = await response.text();
                    
                    // Improved Parser for Multiple Automata
                    const automataMatches = [...text.matchAll(/!AUTOMATON[\s\S]*?code>[\s\S]*?<code/g)];
                    
                    automataMatches.forEach(match => {
                        const block = match[0];
                        const nameMatch = block.match(/name:\s*(.*)/);
                        const verMatch = block.match(/version:\s*(.*)/);
                        const authMatch = block.match(/author:\s*(.*)/);
                        const descMatch = block.match(/description:\s*(.*)/);
                        const codeMatch = block.match(/code>([\s\S]*)<code/);

                        if (nameMatch && codeMatch) {
                            remoteRegistry.push({
                                id: 'remote_' + Math.random().toString(36).substr(2, 9),
                                isRemote: true,
                                sourceUrl: url,
                                name: nameMatch[1].trim(),
                                version: verMatch ? verMatch[1].trim() : '1.0.0',
                                author: authMatch ? authMatch[1].trim() : 'Unknown',
                                description: descMatch ? descMatch[1].trim() : '',
                                code: codeMatch[1].trim()
                            });
                        }
                    });
                } catch (e) {
                    console.error(`Error fetching ${url}:`, e);
                    showToast(`Failed to load source: ${url}`, true);
                }
            });

            await Promise.all(fetchPromises);
            loader.classList.add('hidden');
            renderRegistry();
        }

        // --- Details Viewer ---
        function viewAutomaton(id, isRemote) {
            // Search in both registries
            const item = isRemote 
                ? remoteRegistry.find(r => r.id === id)
                : localRegistry.find(r => r.id === id);

            if(!item) return;

            document.getElementById('modal-name').innerText = item.name;
            document.getElementById('modal-version').innerText = item.version;
            document.getElementById('modal-author').innerText = item.author || 'Unknown';
            document.getElementById('modal-desc').innerText = item.description || 'No description provided.';
            document.getElementById('modal-code').innerText = item.code;
            
            const editBtn = document.getElementById('modal-edit-btn');
            if(isRemote) {
                editBtn.innerText = "Clone to Edit";
                editBtn.onclick = () => {
                    closeDetails();
                    cloneRemote(id);
                };
            } else {
                editBtn.innerText = "Edit This";
                editBtn.onclick = () => {
                    closeDetails();
                    editAutomaton(id);
                };
            }

            document.getElementById('details-modal').classList.add('open');
        }

        function closeDetails() {
            document.getElementById('details-modal').classList.remove('open');
        }

        function cloneRemote(id) {
            const item = remoteRegistry.find(r => r.id === id);
            if(!item) return;
            // Create a new local copy
            currentEditId = null; // New ID
            document.getElementById('edit-name').value = item.name + " (Copy)";
            document.getElementById('edit-version').value = item.version;
            document.getElementById('edit-author').value = item.author;
            document.getElementById('edit-desc').value = item.description;
            document.getElementById('code-editor').value = item.code;
            switchTab('editor');
            showToast("Cloned remote automaton. You can now save it locally.");
        }

        // --- Source Management ---
        function addSource() {
            const input = document.getElementById('source-url');
            const url = input.value.trim();
            if(!url) return showToast("Please enter a URL", true);
            if(sources.includes(url)) return showToast("Source already exists", true);

            sources.push(url);
            localStorage.setItem('akari_automata_urls', JSON.stringify(sources));
            input.value = '';
            renderSources();
            refreshRemote(); // Trigger fetch immediately
            showToast("Source added. Fetching data...");
        }

        function removeSource(url) {
            sources = sources.filter(s => s !== url);
            localStorage.setItem('akari_automata_urls', JSON.stringify(sources));
            renderSources();
            refreshRemote(); // Refresh to remove items
        }

        function renderSources() {
            const list = document.getElementById('source-list');
            if(sources.length === 0) {
                list.innerHTML = '<div class="text-sm text-gray-500 italic">No external sources linked.</div>';
                return;
            }
            list.innerHTML = sources.map(url => `
                <div class="m3-card flex justify-between items-center py-3">
                    <div class="text-sm truncate mr-4 text-[#e6e1e5]">${url}</div>
                    <button onclick="removeSource('${url}')" class="text-xs text-red-400 border border-red-900 rounded px-2 py-1 hover:bg-red-900/20">Remove</button>
                </div>
            `).join('');
        }

        // --- Registry & Editor Logic ---
        function createNew() {
            currentEditId = null;
            clearEditor();
            switchTab('editor');
        }

        function clearEditor() {
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-version').value = '1.0.0';
            document.getElementById('edit-author').value = '';
            document.getElementById('edit-desc').value = '';
            document.getElementById('code-editor').value = '';
        }

        function saveDraft() {
            const data = {
                id: currentEditId || Date.now(),
                name: document.getElementById('edit-name').value,
                version: document.getElementById('edit-version').value,
                author: document.getElementById('edit-author').value,
                description: document.getElementById('edit-desc').value,
                code: document.getElementById('code-editor').value,
                lastUpdated: new Date().toISOString()
            };

            if(!data.name || data.code.length < 5) {
                showToast("Name and valid code required", true);
                return;
            }

            const idx = localRegistry.findIndex(r => r.id === data.id);
            if(idx > -1) localRegistry[idx] = data;
            else localRegistry.push(data);

            localStorage.setItem('akari_local_registry', JSON.stringify(localRegistry));
            showToast("Saved to local registry");
            renderRegistry();
            switchTab('registry');
        }

        function editAutomaton(id) {
            const item = localRegistry.find(r => r.id === id);
            if(!item) return;
            currentEditId = id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-version').value = item.version;
            document.getElementById('edit-author').value = item.author || '';
            document.getElementById('edit-desc').value = item.description;
            document.getElementById('code-editor').value = item.code;
            switchTab('editor');
        }

        function deleteAutomaton(id) {
            if(!confirm('Delete this local automaton?')) return;
            localRegistry = localRegistry.filter(r => r.id !== id);
            localStorage.setItem('akari_local_registry', JSON.stringify(localRegistry));
            renderRegistry();
            showToast("Deleted");
        }

        function exportAtpk() {
            const name = document.getElementById('edit-name').value || 'untitled';
            const code = document.getElementById('code-editor').value;
            const content = `atpk-name: Exported Package\natpk-description: Single export\n\n!AUTOMATON\nname: ${name}\nversion: ${document.getElementById('edit-version').value}\ndescription: ${document.getElementById('edit-desc').value}\ncode>\n${code}\n<code`;
            
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/\s+/g, '_')}.atpk`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                // Simple parser for local uploads
                if(text.includes('!AUTOMATON')) {
                    const nameMatch = text.match(/name:\s*(.*)/);
                    const codeMatch = text.match(/code>([\s\S]*)<code/);
                    if(nameMatch && codeMatch) {
                        localRegistry.push({
                            id: Date.now(),
                            name: nameMatch[1].trim(),
                            version: '1.0.0',
                            description: 'Imported file',
                            code: codeMatch[1].trim()
                        });
                        localStorage.setItem('akari_local_registry', JSON.stringify(localRegistry));
                        renderRegistry();
                        showToast("Imported successfully");
                    }
                }
            };
            reader.readAsText(file);
        }

        function renderRegistry() {
            const list = document.getElementById('registry-list');
            const emptyState = document.getElementById('empty-state');
            
            // Combine Local and Remote for display
            const allItems = [...localRegistry, ...remoteRegistry];

            if (allItems.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                
                list.innerHTML = allItems.map(item => {
                    const isRemote = item.isRemote;
                    // Different buttons for remote vs local
                    const buttons = isRemote 
                        ? `<button onclick="viewAutomaton('${item.id}', true)" class="text-xs py-1.5 px-3 rounded-full bg-[#004a77] text-[#c2e7ff] font-medium hover:bg-[#005a8f] transition w-full">View Remote</button>`
                        : `<button onclick="viewAutomaton(${item.id}, false)" class="text-xs py-1.5 px-3 rounded-full bg-[#4f378b] text-[#eaddff] font-medium hover:bg-[#5f44a3] transition">View</button>
                           <button onclick="editAutomaton(${item.id})" class="text-xs py-1.5 px-3 rounded-full border border-[#938f99] hover:bg-[#49454f] transition">Edit</button>
                           <button onclick="deleteAutomaton(${item.id})" class="text-xs py-1.5 px-3 rounded-full border border-red-900 text-red-300 hover:bg-red-900/30 transition ml-auto">Delete</button>`;

                    const badge = isRemote ? `<span class="badge-remote">Cloud</span>` : '';

                    return `
                    <div class="m3-card group relative flex flex-col h-full ${isRemote ? 'border-[#004a77]' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-medium text-lg text-[#eaddff] flex items-center">
                                    ${item.name} ${badge}
                                </div>
                                <div class="text-xs text-[#938f99]">v${item.version} ${isRemote ? 'â€¢ ' + item.author : ''}</div>
                            </div>
                        </div>
                        <div class="text-sm text-[#cac4d0] mb-4 line-clamp-2 flex-grow">${item.description || 'No description'}</div>
                        <div class="flex gap-2 mt-auto">
                            ${buttons}
                        </div>
                    </div>`;
                }).join('');
            }
        }
    </script>
</body>
</html>
